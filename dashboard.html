<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Ticketing - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="img/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .navbar-brand {
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      font-size: 1.5rem;
    }

    .navbar-brand i {
      margin-right: 8px;
      font-size: 1.75rem;
    }
  </style>
</head>

<body>
  <button class="btn toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar"
    aria-controls="sidebar">
    <i class="bi bi-list"></i>
  </button>

  <div class="offcanvas offcanvas-start sidebar" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarLabel">Event Ticketing</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <nav class="nav flex-column">
        <a class="nav-link active" href="#" data-section="events"><i class="bi bi-calendar-event me-2"></i>Browse
          Events</a>
        <a class="nav-link create-event-link" href="#" data-section="createEvent"><i
            class="bi bi-plus-circle me-2"></i>Create Event</a>
        <a class="nav-link organizer-controls-link" href="#" data-section="organizerControls"><i
            class="bi bi-gear me-2"></i>Organizer Controls</a>
        <a class="nav-link" href="#" data-section="verifyTicket"><i class="bi bi-check-circle me-2"></i>Verify
          Ticket</a>
        <a class="nav-link" href="#" data-section="transferTicket"><i class="bi bi-arrow-left-right me-2"></i>Request
          Ticket Trade</a>
        <a class="nav-link" href="#" data-section="acceptTransfer"><i class="bi bi-arrow-down-circle me-2"></i>Complete
          Ticket Trade</a>
        <a class="nav-link" href="#" data-section="pendingTrades"><i class="bi bi-hourglass-split me-2"></i>Pending
          Trade Requests</a>
        <a class="nav-link" href="#" data-section="pendingPayments"><i class="bi bi-clock me-2"></i>Pending Payments</a>
        <a class="nav-link" href="#" data-section="myTickets"><i class="bi bi-ticket me-2"></i>My Tickets</a>
        <a class="nav-link" href="index.html" id="logoutLink"><i class="bi bi-box-arrow-left me-2"></i>Logout</a>
      </nav>
    </div>
  </div>

  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Processing transaction...</span>
          </div>
          <p class="mt-2 text-white">Processing transaction...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    <!-- Toasts will be dynamically added here -->
  </div>

  <div class="content">
    <h1 class="mb-4 navbar-brand">
      <i class="fas fa-ticket-alt me-2"></i> TICKETERIUM
    </h1>
    <p id="accountStatus" class="mb-3 badge"></p>

    <div id="events" class="section">
      <div class="card">
        <div class="card-header">Browse Events</div>
        <div class="card-body" id="eventsList"></div>
      </div>
    </div>

    <div id="createEvent" class="section d-none">
      <div class="card">
        <div class="card-header">Create Event</div>
        <div class="card-body">
          <form id="createEventForm">
            <div class="mb-3">
              <label for="eventName" class="form-label">Event Name</label>
              <input type="text" class="form-control" id="eventName" required aria-describedby="eventNameHelp">
              <div id="eventNameHelp" class="form-text">Enter a unique name for your event.</div>
            </div>
            <div class="mb-3">
              <label for="eventDescription" class="form-label">Description</label>
              <textarea class="form-control" id="eventDescription" required rows="4"></textarea>
            </div>
            <div class="mb-3">
              <label for="eventLocation" class="form-label">Location</label>
              <input type="text" class="form-control" id="eventLocation" required>
            </div>
            <div class="mb-3">
              <label for="eventDate" class="form-label">Date and Time</label>
              <input type="datetime-local" class="w-100" id="eventDate" required>
            </div>
            <div class="mb-3">
              <label for="ticketPrice" class="form-label">Ticket Price (ETH)</label>
              <input type="number" step="0.001" class="form-control" id="ticketPrice" required>
            </div>
            <div class="mb-3">
              <label for="totalSupply" class="form-label">Total Tickets</label>
              <input type="number" class="form-control" id="totalSupply" required>
            </div>
            <div class="mb-3">
              <label for="resalePriceCap" class="form-label">Resale Price Cap (ETH)</label>
              <input type="number" step="0.001" class="form-control" id="resalePriceCap" required>
            </div>
            <div class="mb-3">
              <label for="maxTicketsPerAddress" class="form-label">Max Tickets per Address</label>
              <input type="number" class="form-control" id="maxTicketsPerAddress" required>
            </div>
            <div class="mb-3">
              <label for="transferable" class="form-label">Allow Transfers</label>
              <select class="form-control" id="transferable" required>
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">Create Event</button>
          </form>
        </div>
      </div>
    </div>

    <div id="organizerControls" class="section d-none">
      <div class="card">
        <div class="card-header">Organizer Controls</div>
        <div class="card-body">
          <div class="mb-3">
            <label for="platformIncentive" class="form-label">Platform Incentive (ETH)</label>
            <input type="number" step="0.001" class="form-control" id="platformIncentive" required>
            <button class="btn btn-primary mt-2 w-100" id="setIncentive">Set Platform Incentive</button>
          </div>
          <div class="mb-3">
            <label for="cancelEventId" class="form-label">Cancel Event ID</label>
            <input type="number" class="form-control" id="cancelEventId" required>
            <button class="btn btn-danger mt-2 w-100" id="cancelEvent">Cancel Event</button>
          </div>
          <div class="mb-3">
            <label for="releaseEventId" class="form-label">Release Funds Event ID</label>
            <input type="number" class="form-control" id="releaseEventId" required>
            <button class="btn btn-warning mt-2 w-100" id="releaseFunds">Release Funds</button>
          </div>
          <div class="mb-3 d-flex gap-2">
            <button class="btn btn-secondary w-50" id="pauseContract">Pause Contract</button>
            <button class="btn btn-secondary w-50" id="unpauseContract">Unpause Contract</button>
          </div>
          <div class="mb-3">
            <label for="newOwner" class="form-label">Transfer Ownership</label>
            <input type="text" class="form-control" id="newOwner" required>
            <button class="btn btn-primary mt-2 w-100" id="transferOwnership">Transfer Ownership</button>
          </div>
          <div class="mb-3">
            <label for="removeEventId" class="form-label">Remove Canceled Event ID</label>
            <input type="number" class="form-control" id="removeEventId" required>
            <button class="btn btn-danger mt-2 w-100" id="removeEvent">Remove Event</button>
          </div>
        </div>
      </div>
    </div>

    <div id="verifyTicket" class="section d-none">
      <div class="card">
        <div class="card-header">Verify Ticket</div>
        <div class="card-body">
          <form id="verifyTicketForm">
            <div class="mb-3">
              <label for="verifyEventId" class="form-label">Event ID</label>
              <input type="number" class="form-control" id="verifyEventId" required>
            </div>
            <div class="mb-3">
              <label for="verifyTicketId" class="form-label">Ticket ID</label>
              <input type="number" class="form-control" id="verifyTicketId" required>
            </div>
            <div class="mb-3">
              <label for="verifyAttendee" class="form-label">Attendee Address</label>
              <input type="text" class="form-control" id="verifyAttendee" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="useMyAddress" checked>
              <label class="form-check-label" for="useMyAddress">Verify my own ticket</label>
            </div>
            <button type="submit" class="btn btn-info w-100">Verify Ticket</button>
          </form>
          <p id="verifyResult" class="mt-2"></p>
        </div>
      </div>
    </div>

    <div id="transferTicket" class="section d-none">
      <div class="card">
        <div class="card-header">Request Ticket Trade</div>
        <div class="card-body">
          <form id="transferTicketForm">
            <div class="mb-3">
              <label for="transferEventId" class="form-label">Event ID</label>
              <input type="number" class="form-control" id="transferEventId" required>
            </div>
            <div class="mb-3">
              <label for="transferTicketId" class="form-label">Ticket ID</label>
              <input type="number" class="form-control" id="transferTicketId" required>
            </div>
            <div class="mb-3">
              <label for="transferTo" class="form-label">Seller Address</label>
              <input type="text" class="form-control" id="transferTo" required>
            </div>
            <div class="mb-3">
              <label for="resalePrice" class="form-label">Negotiated Price (ETH)</label>
              <input type="number" step="0.001" class="form-control" id="resalePrice" required>
            </div>
            <button type="submit" class="btn btn-warning w-100">Request Trade</button>
          </form>
        </div>
      </div>
    </div>

    <div id="acceptTransfer" class="section d-none">
      <div class="card">
        <div class="card-header">Complete Ticket Trade</div>
        <div class="card-body">
          <form id="acceptTransferForm">
            <div class="mb-3">
              <label for="acceptEventId" class="form-label">Event ID</label>
              <input type="number" class="form-control" id="acceptEventId" required>
            </div>
            <div class="mb-3">
              <label for="acceptTicketId" class="form-label">Ticket ID</label>
              <input type="number" class="form-control" id="acceptTicketId" required>
            </div>
            <button type="submit" class="btn btn-success w-100">Complete Trade</button>
          </form>
        </div>
      </div>
    </div>

    <div id="pendingTrades" class="section d-none">
      <div class="card">
        <div class="card-header">Pending Trade Requests</div>
        <div class="card-body">
          <div id="pendingTradesList" class="ticket-list"></div>
        </div>
      </div>
    </div>

    <div id="pendingPayments" class="section d-none">
      <div class="card">
        <div class="card-header">Pending Payments</div>
        <div class="card-body">
          <div id="pendingPaymentsList" class="ticket-list"></div>
        </div>
      </div>
    </div>

    <div id="myTickets" class="section d-none">
      <div class="card">
        <div class="card-header">My Tickets</div>
        <div class="card-body">
          <div id="trustViolations" class="mb-3"></div>
          <div id="ticketsList" class="ticket-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script>
    const contractAddress = "0x006B932f09F85f42C480Aa5872AE9d3F2CF18ea8";
    const contractABI = [
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_ticketId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_paymentWindow",
            "type": "uint256"
          }
        ],
        "name": "acceptTicketTrade",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          }
        ],
        "name": "cancelEvent",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_ticketId",
            "type": "uint256"
          }
        ],
        "name": "cancelTradePayment",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_ticketId",
            "type": "uint256"
          }
        ],
        "name": "cancelTradeRequest",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_ticketId",
            "type": "uint256"
          }
        ],
        "name": "completeTicketTrade",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "string",
            "name": "_name",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_description",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_location",
            "type": "string"
          },
          {
            "internalType": "uint256",
            "name": "_date",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_ticketPrice",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_totalSupply",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_resalePriceCap",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_maxTicketsPerAddress",
            "type": "uint256"
          },
          {
            "internalType": "bool",
            "name": "_transferable",
            "type": "bool"
          }
        ],
        "name": "createEvent",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "owner",
            "type": "address"
          }
        ],
        "name": "OwnableInvalidOwner",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "OwnableUnauthorizedAccount",
        "type": "error"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          }
        ],
        "name": "EventCanceled",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "string",
            "name": "name",
            "type": "string"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "date",
            "type": "uint256"
          }
        ],
        "name": "EventCreated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "FundsReleased",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "previousOwner",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "newOwner",
            "type": "address"
          }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "pause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "Paused",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_quantity",
            "type": "uint256"
          }
        ],
        "name": "purchaseTickets",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "ticketId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "RefundIssued",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_ticketId",
            "type": "uint256"
          }
        ],
        "name": "refundTicket",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          }
        ],
        "name": "releaseFunds",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          }
        ],
        "name": "removeEvent",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "renounceOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_ticketId",
            "type": "uint256"
          },
          {
            "internalType": "address",
            "name": "_seller",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "_price",
            "type": "uint256"
          }
        ],
        "name": "requestTicketTrade",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_incentive",
            "type": "uint256"
          }
        ],
        "name": "setPlatformIncentive",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "ticketId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "buyer",
            "type": "address"
          }
        ],
        "name": "TicketPurchased",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "ticketId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "seller",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "buyer",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "paymentWindow",
            "type": "uint256"
          }
        ],
        "name": "TradeAccepted",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "ticketId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "seller",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "buyer",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "price",
            "type": "uint256"
          }
        ],
        "name": "TradeCompleted",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "ticketId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "seller",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "buyer",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "incentiveToSeller",
            "type": "uint256"
          }
        ],
        "name": "TradePaymentTimedOut",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "ticketId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "seller",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "buyer",
            "type": "address"
          }
        ],
        "name": "TradeRequestTimedOut",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "ticketId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "seller",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "buyer",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "price",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "incentive",
            "type": "uint256"
          }
        ],
        "name": "TradeRequested",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "newOwner",
            "type": "address"
          }
        ],
        "name": "transferOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "buyer",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "uint256",
            "name": "eventId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "violations",
            "type": "uint256"
          }
        ],
        "name": "TrustViolation",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "unpause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "Unpaused",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "eventCounter",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "eventFunds",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "events",
        "outputs": [
          {
            "internalType": "string",
            "name": "name",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "description",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "location",
            "type": "string"
          },
          {
            "internalType": "uint256",
            "name": "date",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "ticketPrice",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "totalSupply",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "ticketsSold",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "resalePriceCap",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "maxTicketsPerAddress",
            "type": "uint256"
          },
          {
            "internalType": "bool",
            "name": "transferable",
            "type": "bool"
          },
          {
            "internalType": "bool",
            "name": "canceled",
            "type": "bool"
          },
          {
            "internalType": "bool",
            "name": "exists",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "_user",
            "type": "address"
          }
        ],
        "name": "getUserTickets",
        "outputs": [
          {
            "internalType": "uint256[]",
            "name": "eventIds",
            "type": "uint256[]"
          },
          {
            "internalType": "uint256[][]",
            "name": "ticketIds",
            "type": "uint256[][]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "paused",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "platformIncentive",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "ticketOwners",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "ticketRefunded",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "tradeRequests",
        "outputs": [
          {
            "internalType": "address",
            "name": "seller",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "buyer",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "ticketId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "price",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "buyerIncentive",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "sellerIncentive",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "requestTimestamp",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "paymentWindow",
            "type": "uint256"
          },
          {
            "internalType": "bool",
            "name": "active",
            "type": "bool"
          },
          {
            "internalType": "bool",
            "name": "accepted",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "trustViolations",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "userTickets",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_eventId",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "_ticketId",
            "type": "uint256"
          },
          {
            "internalType": "address",
            "name": "_owner",
            "type": "address"
          }
        ],
        "name": "verifyTicket",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    let web3, contract, account, contractOwner;

    async function initWeb3() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          const chainId = await web3.eth.getChainId();
          if (chainId !== 11155111) {
            showAlert("Please switch to Sepolia Testnet in MetaMask", "warning");
            window.location.href = 'index.html';
            return;
          }
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          if (accounts.length === 0) {
            showAlert("Please connect MetaMask", "warning");
            window.location.href = 'index.html';
            return;
          }
          account = accounts[0];
          contract = new web3.eth.Contract(contractABI, contractAddress);
          contractOwner = await contract.methods.owner().call();
          const isOwner = account.toLowerCase() === contractOwner.toLowerCase();
          const role = isOwner ? 'Organizer' : 'Attendee';
          const badgeClass = isOwner ? 'bg-success' : 'bg-primary';
          const shortAccount = `${account.slice(0, 6)}...${account.slice(-4)}`;
          const accountStatus = document.getElementById('accountStatus');
          accountStatus.className = `mb-3 badge ${badgeClass}`;
          accountStatus.innerText = `Connected: ${role} (${shortAccount})`;
          accountStatus.setAttribute('aria-label', `Connected as ${role} with account ${shortAccount}`);

          if (!isOwner) {
            document.querySelector('.create-event-link').classList.add('hidden');
            document.querySelector('.organizer-controls-link').classList.add('hidden');
            document.getElementById('createEvent').classList.add('d-none');
            document.getElementById('organizerControls').classList.add('d-none');
          }

          initVerifyForm();
          loadEvents();
          loadTickets();
          loadPendingTrades();
          loadPendingPayments();
          loadTrustViolations();
          initSidebar();
        } catch (error) {
          console.error("Initialization error:", error);
          showAlert("Failed to initialize DApp: " + error.message, "danger");
          window.location.href = 'index.html';
        }
      } else {
        showAlert("Please install MetaMask", "warning");
        window.location.href = 'index.html';
      }
    }

    async function disconnectWallet() {
      try {
        if (window.ethereum && window.ethereum.isMetaMask) {
          await window.ethereum.request({
            method: 'wallet_revokePermissions',
            params: [{ eth_accounts: {} }],
          });
          web3 = null;
          account = null;
          contract = null;
        }
      } catch (error) {
        console.error("Error disconnecting wallet:", error);
        showAlert("Failed to disconnect wallet: " + error.message, "warning");
      }
    }

    function initSidebar() {
      const offcanvasElement = document.getElementById('sidebar');
      const toggleBtn = document.querySelector('.toggle-btn');
      const content = document.querySelector('.content');
      if (!offcanvasElement || !toggleBtn) {
        console.error("Sidebar or toggle button not found");
        showAlert("Sidebar initialization failed", "danger");
        return;
      }
      const bsOffcanvas = new bootstrap.Offcanvas(offcanvasElement);

      toggleBtn.addEventListener('click', () => {
        toggleBtn.style.display = 'none';
      });

      offcanvasElement.addEventListener('hidden.bs.offcanvas', () => {
        toggleBtn.style.display = 'flex';
        content.classList.remove('sidebar-open');
      });

      offcanvasElement.addEventListener('shown.bs.offcanvas', () => {
        content.classList.add('sidebar-open');
      });
    }

    function showAlert(message, type) {
      const toastContainer = document.querySelector('.toast-container');
      const toastId = `toast-${Date.now()}`;
      const bgClass = {
        success: 'bg-success',
        warning: 'bg-warning',
        danger: 'bg-danger',
        info: 'bg-info'
      }[type] || 'bg-primary';
      const textClass = type === 'warning' ? 'text-dark' : 'text-white';

      const toastHTML = `
        <div id="${toastId}" class="toast ${bgClass} ${textClass}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="1500">
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);

      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement);
      toast.show();

      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    }

    function showLoadingIndicator() {
      const modal = new bootstrap.Modal(document.getElementById('loadingModal'), {
        backdrop: 'static',
        keyboard: false
      });
      modal.show();
    }

    function hideLoadingIndicator() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
      if (modal) {
        modal.hide();
      }
    }

    function handleError(error) {
      const message = error.reason || error.message;
      const friendlyMessage = {
        'E1': 'Event does not exist',
        'C1': 'Event is canceled',
        'T1': 'Event has already occurred',
        'Q1': 'Quantity must be greater than 0',
        'A1': 'Not enough tickets available',
        'P1': 'Incorrect payment amount',
        'M2': 'Exceeds max tickets per address',
        'V1': 'Too many trust violations (5 max)',
        'R2': 'Refund transfer failed',
        'C2': 'Event is not canceled',
        'O1': 'Not ticket owner',
        'R3': 'Ticket already refunded',
        'T2': 'Event has not yet occurred',
        'F1': 'No funds to release',
        'F2': 'Fund release failed',
        'TR1': 'Tickets are not transferable',
        'O2': 'Seller does not own ticket',
        'S1': 'Cannot trade with yourself',
        'R1': 'Price exceeds resale cap',
        'I2': 'Incorrect incentive amount',
        'TR2': 'Trade request already active',
        'TR3': 'No active trade request',
        'S2': 'Not the seller',
        'T3': 'Request timed out',
        'W1': 'Payment window must be 10-30 minutes',
        'TR4': 'Trade not accepted',
        'B1': 'Not the buyer',
        'T4': 'Payment window expired',
        'P2': 'Payment to seller failed',
        'I3': 'Incentive transfer failed',
        'T5': 'Request not timed out',
        'A2': 'Not authorized',
        'I4': 'Incentive refund failed',
        'I5': 'Incentive transfer to seller failed',
        'T6': 'Payment window not expired',
        'I1': 'Incentive must be greater than 0',
        'N1': 'Name cannot be empty',
        'D1': 'Date must be at least 1 hour in future',
        'S1': 'Invalid ticket supply',
        'M1': 'Invalid max tickets per address'
      }[message] || message;
      showAlert(`Error: ${friendlyMessage}`, 'danger');
    }

    async function loadEvents() {
      const eventsList = document.getElementById('eventsList');
      eventsList.innerHTML = '<p>Loading events...</p>';
      try {
        const eventCount = await contract.methods.eventCounter().call();
        if (eventCount == 0) {
          eventsList.innerHTML = '<p>No events found. Create an event to get started!</p>';
          return;
        }
        let eventsHTML = '<div class="row">';
        for (let i = 1; i <= eventCount; i++) {
          try {
            const event = await contract.methods.events(i).call();
            if (event.exists) {
              eventsHTML += `
                <div class="col-md-4 mb-4">
                  <div class="card event-card h-100">
                    <img src="https://images.unsplash.com/photo-1514525253161-7a46d19cd819?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=60" 
                         class="card-img-top" 
                         alt="${event.name}" 
                         onerror="this.src='assets/event-placeholder.jpg'">
                    <div class="card-body d-flex flex-column">
                      <h5 class="card-title">Event ID: ${i} - ${event.name}</h5>
                      <p class="card-text">
                        <strong>Date:</strong> ${new Date(event.date * 1000).toLocaleString()}<br>
                        <strong>Price:</strong> ${web3.utils.fromWei(event.ticketPrice, 'ether')} ETH<br>
                        <strong>Tickets:</strong> ${event.totalSupply - event.ticketsSold}/${event.totalSupply}<br>
                        <strong>Status:</strong> ${event.canceled ? 'Canceled' : 'Active'}
                      </p>
                      <div class="mb-3">
                        <label for="quantity-${i}" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity-${i}" min="1" value="1" aria-label="Ticket quantity for event ${event.name}">
                      </div>
                      <button class="btn btn-primary w-100 buy-ticket mt-auto" 
                              data-event-id="${i}" 
                              ${event.canceled ? 'disabled' : ''} 
                              aria-label="Buy tickets for ${event.name}">
                        <i class="bi bi-ticket-fill me-2"></i>Buy Tickets
                      </button>
                    </div>
                  </div>
                </div>
              `;
            }
          } catch (error) {
            console.error(`Error loading event ${i}:`, error);
          }
        }
        eventsHTML += '</div>';
        eventsList.innerHTML = eventsHTML;
        if (eventsList.querySelector('.row').children.length === 0) {
          eventsList.innerHTML = '<p>No valid events found</p>';
        }
        addBuyTicketListeners();
      } catch (error) {
        console.error("Error loading events:", error);
        eventsList.innerHTML = '<p>Error loading events: ' + error.message + '</p>';
      }
    }

    function addBuyTicketListeners() {
      document.querySelectorAll('.buy-ticket').forEach(button => {
        button.addEventListener('click', async (e) => {
          const eventId = e.target.dataset.eventId;
          const quantityInput = document.getElementById(`quantity-${eventId}`);
          const quantity = quantityInput.value;
          if (!quantity || quantity < 1) {
            showAlert("Quantity must be at least 1", "warning");
            return;
          }
          try {
            const event = await contract.methods.events(eventId).call();
            if (!event.exists) throw new Error('Event does not exist');
            if (event.canceled) throw new Error('Event is canceled');
            if (parseInt(event.ticketsSold) + parseInt(quantity) > parseInt(event.totalSupply)) {
              throw new Error('Not enough tickets available');
            }
            const totalPrice = BigInt(event.ticketPrice) * BigInt(quantity);
            showLoadingIndicator();
            await contract.methods.purchaseTickets(eventId, quantity)
              .send({ from: account, value: totalPrice.toString() });
            hideLoadingIndicator();
            showAlert("Tickets purchased successfully!", "success");
            loadEvents();
            loadTickets();
          } catch (error) {
            hideLoadingIndicator();
            handleError(error);
          }
        });
      });
    }

    async function loadTickets() {
      const ticketsList = document.getElementById('ticketsList');
      ticketsList.innerHTML = '<p>Loading tickets...</p>';
      try {
        const result = await contract.methods.getUserTickets(account).call();
        const eventIds = result[0] || [];
        const ticketIds = result[1] || [];

        if (eventIds.length === 0 || ticketIds.length === 0) {
          ticketsList.innerHTML = '<p>No tickets found</p>';
          return;
        }

        ticketsList.innerHTML = '';
        for (let i = 0; i < eventIds.length; i++) {
          const eventId = eventIds[i];
          const eventTickets = ticketIds[i] || [];
          try {
            const event = await contract.methods.events(eventId).call();
            if (event.exists) {
              const ticketSection = document.createElement('div');
              ticketSection.className = 'mb-3';
              ticketSection.innerHTML = `
                <h5>Event ID: ${eventId} - ${event.name}</h5>
                <p><strong>Date:</strong> ${new Date(event.date * 1000).toLocaleString()}</p>
                <p><strong>Location:</strong> ${event.location}</p>
                <ul class="list-group" id="ticket-list-${eventId}"></ul>
              `;
              ticketsList.appendChild(ticketSection);
              const ul = ticketSection.querySelector(`#ticket-list-${eventId}`);
              for (const ticketId of eventTickets) {
                const ticketItem = document.createElement('li');
                ticketItem.className = 'list-group-item';
                ticketItem.innerText = `Ticket ID: ${ticketId}`;
                ul.appendChild(ticketItem);
              }
            }
          } catch (error) {
            console.error(`Error loading event ${eventId}:`, error);
          }
        }
        if (!ticketsList.hasChildNodes()) {
          ticketsList.innerHTML = '<p>No valid tickets found</p>';
        }
      } catch (error) {
        console.error("Error loading tickets:", error);
        ticketsList.innerHTML = '<p>Error loading tickets: ' + error.message + '</p>';
      }
    }

    async function loadPendingTrades() {
      const tradesList = document.getElementById('pendingTradesList');
      tradesList.innerHTML = '<p>Loading pending trades...</p>';
      try {
        const eventCount = await contract.methods.eventCounter().call();
        let tradesHTML = '';
        let hasTrades = false;
        for (let eventId = 1; eventId <= eventCount; eventId++) {
          const event = await contract.methods.events(eventId).call();
          if (event.exists) {
            for (let ticketId = 1; ticketId <= event.ticketsSold; ticketId++) {
              const request = await contract.methods.tradeRequests(eventId, ticketId).call();
              if (request.active && request.seller.toLowerCase() === account.toLowerCase()) {
                hasTrades = true;
                const timeLeft = request.accepted ? 0 : (request.requestTimestamp * 1000) + 600000 - Date.now();
                tradesHTML += `
                  <div class="mb-3">
                    <p>
                      Event ID: ${eventId}, Ticket ID: ${ticketId}<br>
                      Buyer: ${request.buyer}<br>
                      Price: ${web3.utils.fromWei(request.price, 'ether')} ETH<br>
                      Incentive: ${web3.utils.fromWei(request.buyerIncentive, 'ether')} ETH<br>
                      Status: ${request.accepted ? 'Accepted' : 'Pending Acceptance'}<br>
                      ${!request.accepted ? `<span class="countdown" data-time="${timeLeft}"></span>` : ''}
                    </p>
                    ${!request.accepted ? `
                      <div class="mb-2">
                        <label for="paymentWindow-${eventId}-${ticketId}" class="form-label">Payment Window (minutes, 10-30)</label>
                        <input type="number" class="form-control" id="paymentWindow-${eventId}-${ticketId}" min="10" max="30" value="10">
                        <button class="btn btn-primary w-100 mt-2 accept-trade" data-event-id="${eventId}" data-ticket-id="${ticketId}">Accept Trade</button>
                      </div>
                      <button class="btn btn-danger w-100 cancel-trade" data-event-id="${eventId}" data-ticket-id="${ticketId}" ${timeLeft > 0 ? 'disabled' : ''}>Cancel Trade</button>
                    ` : ''}
                  </div>
                `;
              }
            }
          }
        }
        tradesList.innerHTML = tradesHTML || '<p>No pending trade requests</p>';
        if (hasTrades) {
          addTradeListeners();
        }
        updateCountdowns();
      } catch (error) {
        console.error("Error loading pending trades:", error);
        tradesList.innerHTML = '<p>Error loading trades: ' + error.message + '</p>';
      }
    }

    function addTradeListeners() {
      document.querySelectorAll('.accept-trade').forEach(button => {
        button.addEventListener('click', async (e) => {
          const eventId = e.target.dataset.eventId;
          const ticketId = e.target.dataset.ticketId;
          const paymentWindow = document.getElementById(`paymentWindow-${eventId}-${ticketId}`).value * 60;
          try {
            showLoadingIndicator();
            const incentive = await contract.methods.platformIncentive().call();
            await contract.methods.acceptTicketTrade(eventId, ticketId, paymentWindow)
              .send({ from: account, value: incentive });
            hideLoadingIndicator();
            showAlert("Trade accepted successfully!", "success");
            loadPendingTrades();
            loadPendingPayments();
          } catch (error) {
            hideLoadingIndicator();
            handleError(error);
          }
        });
      });
      document.querySelectorAll('.cancel-trade').forEach(button => {
        button.addEventListener('click', async (e) => {
          const eventId = e.target.dataset.eventId;
          const ticketId = e.target.dataset.ticketId;
          try {
            showLoadingIndicator();
            await contract.methods.cancelTradeRequest(eventId, ticketId).send({ from: account });
            hideLoadingIndicator();
            showAlert("Trade request canceled, buyer refunded!", "success");
            loadPendingTrades();
          } catch (error) {
            hideLoadingIndicator();
            handleError(error);
          }
        });
      });
    }

    async function loadPendingPayments() {
      const paymentsList = document.getElementById('pendingPaymentsList');
      paymentsList.innerHTML = '<p>Loading pending payments...</p>';
      try {
        const eventCount = await contract.methods.eventCounter().call();
        let paymentsHTML = '';
        let hasPayments = false;
        for (let eventId = 1; eventId <= eventCount; eventId++) {
          const event = await contract.methods.events(eventId).call();
          if (event.exists) {
            for (let ticketId = 1; ticketId <= event.ticketsSold; ticketId++) {
              const request = await contract.methods.tradeRequests(eventId, ticketId).call();
              if (request.active && request.accepted && request.buyer.toLowerCase() === account.toLowerCase()) {
                hasPayments = true;
                const deadline = (request.requestTimestamp * 1000) + 600000 + (request.paymentWindow * 1000);
                const timeLeft = deadline - Date.now();
                paymentsHTML += `
                  <div class="mb-3">
                    <p>
                      Event ID: ${eventId}, Ticket ID: ${ticketId}<br>
                      Seller: ${request.seller}<br>
                      Price: ${web3.utils.fromWei(request.price, 'ether')} ETH<br>
                      Incentive: ${web3.utils.fromWei(request.buyerIncentive, 'ether')} ETH<br>
                      <span class="countdown" data-time="${timeLeft}"></span>
                    </p>
                    <button class="btn btn-primary w-100 complete-trade" data-event-id="${eventId}" data-ticket-id="${ticketId}">Complete Payment</button>
                  </div>
                `;
              }
            }
          }
        }
        paymentsList.innerHTML = paymentsHTML || '<p>No pending payments</p>';
        if (hasPayments) {
          addPaymentListeners();
        }
        updateCountdowns();
      } catch (error) {
        console.error("Error loading pending payments:", error);
        paymentsList.innerHTML = '<p>Error loading payments: ' + error.message + '</p>';
      }
    }

    function addPaymentListeners() {
      document.querySelectorAll('.complete-trade').forEach(button => {
        button.addEventListener('click', async (e) => {
          const eventId = e.target.dataset.eventId;
          const ticketId = e.target.dataset.ticketId;
          try {
            showLoadingIndicator();
            const request = await contract.methods.tradeRequests(eventId, ticketId).call();
            await contract.methods.completeTicketTrade(eventId, ticketId)
              .send({ from: account, value: request.price });
            hideLoadingIndicator();
            showAlert("Trade completed successfully!", "success");
            loadPendingPayments();
            loadTickets();
          } catch (error) {
            hideLoadingIndicator();
            handleError(error);
          }
        });
      });
    }

    async function loadTrustViolations() {
      const violationsDiv = document.getElementById('trustViolations');
      violationsDiv.innerHTML = '';
      try {
        const result = await contract.methods.getUserTickets(account).call();
        const eventIds = result[0] || [];
        let hasViolations = false;
        for (const eventId of eventIds) {
          const violations = await contract.methods.trustViolations(account, eventId).call();
          if (violations > 0) {
            hasViolations = true;
            const alertType = violations >= 5 ? 'danger' : violations >= 3 ? 'warning' : 'info';
            violationsDiv.innerHTML += `
              <div class="alert alert-${alertType}">
                Event ID ${eventId}: ${violations}/5 trust violations. 
                ${violations >= 5 ? 'You cannot purchase tickets for this event.' : 'Avoid further violations.'}
              </div>
            `;
          }
        }
        if (!hasViolations) {
          violationsDiv.innerHTML = '<p>No trust violations.</p>';
        }
      } catch (error) {
        console.error("Error loading trust violations:", error);
        violationsDiv.innerHTML = '<p>Error loading trust violations: ' + error.message + '</p>';
      }
    }

    function updateCountdowns() {
      document.querySelectorAll('.countdown').forEach(span => {
        const timeLeft = parseInt(span.dataset.time);
        if (timeLeft <= 0) {
          span.innerText = 'Expired';
          const cancelButton = span.closest('.mb-3').querySelector('.cancel-trade');
          if (cancelButton) cancelButton.disabled = false;
        } else {
          const minutes = Math.floor(timeLeft / 60000);
          const seconds = Math.floor((timeLeft % 60000) / 1000);
          span.innerText = `Time left: ${minutes}m ${seconds}s`;
        }
      });
      setTimeout(updateCountdowns, 1000);
    }

    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', async (e) => {
        e.preventDefault();
        const section = link.dataset.section;
        const isLogout = link.id === 'logoutLink';

        if (isLogout) {
          await disconnectWallet();
          window.location.href = 'index.html';
          return;
        }

        if ((section === 'createEvent' || section === 'organizerControls') && account.toLowerCase() !== contractOwner.toLowerCase()) {
          return;
        }

        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
        document.getElementById(section).classList.remove('d-none');
        if (section === 'myTickets') {
          loadTickets();
          loadTrustViolations();
        } else if (section === 'pendingTrades') {
          loadPendingTrades();
        } else if (section === 'pendingPayments') {
          loadPendingPayments();
        }
        const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('sidebar'));
        if (offcanvas) {
          offcanvas.hide();
        }
      });
    });

    document.getElementById('createEventForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('eventName').value;
      const description = document.getElementById('eventDescription').value;
      const location = document.getElementById('eventLocation').value;
      const date = Math.floor(new Date(document.getElementById('eventDate').value).getTime() / 1000);
      const ticketPrice = web3.utils.toWei(document.getElementById('ticketPrice').value, 'ether');
      const totalSupply = parseInt(document.getElementById('totalSupply').value);
      const resalePriceCap = web3.utils.toWei(document.getElementById('resalePriceCap').value, 'ether');
      const maxTicketsPerAddress = parseInt(document.getElementById('maxTicketsPerAddress').value);
      const transferable = document.getElementById('transferable').value === 'true';

      if (name.length === 0) {
        showAlert("Event name cannot be empty", "warning");
        return;
      }
      const nowPlusOneHour = Math.floor(Date.now() / 1000) + 3600;
      if (date <= nowPlusOneHour) {
        showAlert("Event date must be at least 1 hour in the future", "warning");
        return;
      }
      if (totalSupply < 1 || totalSupply > 10000) {
        showAlert("Total supply must be between 1 and 10,000", "warning");
        return;
      }
      if (parseInt(resalePriceCap) < parseInt(ticketPrice)) {
        showAlert("Resale price cap must be at least ticket price", "warning");
        return;
      }
      if (maxTicketsPerAddress < 1 || maxTicketsPerAddress > totalSupply) {
        showAlert("Max tickets per address must be between 1 and total supply", "warning");
        return;
      }

      try {
        showLoadingIndicator();
        await contract.methods.createEvent(name, description, location, date, ticketPrice, totalSupply, resalePriceCap, maxTicketsPerAddress, transferable)
          .send({ from: account });
        hideLoadingIndicator();
        showAlert("Event created successfully!", "success");
        loadEvents();
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    document.getElementById('setIncentive').addEventListener('click', async () => {
      const incentive = web3.utils.toWei(document.getElementById('platformIncentive').value, 'ether');
      if (!incentive || incentive <= 0) {
        showAlert("Please enter a valid incentive amount", "warning");
        return;
      }
      try {
        showLoadingIndicator();
        await contract.methods.setPlatformIncentive(incentive).send({ from: account });
        hideLoadingIndicator();
        showAlert("Platform incentive set successfully!", "success");
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    document.getElementById('cancelEvent').addEventListener('click', async () => {
      const eventId = document.getElementById('cancelEventId').value;
      if (!eventId) {
        showAlert("Please enter event ID", "warning");
        return;
      }
      try {
        showLoadingIndicator();
        await contract.methods.cancelEvent(eventId).send({ from: account });
        hideLoadingIndicator();
        showAlert("Event canceled and refunds issued!", "success");
        loadEvents();
        loadTickets();
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    document.getElementById('releaseFunds').addEventListener('click', async () => {
      const eventId = document.getElementById('releaseEventId').value;
      if (!eventId) {
        showAlert("Please enter event ID", "warning");
        return;
      }
      try {
        showLoadingIndicator();
        await contract.methods.releaseFunds(eventId).send({ from: account });
        hideLoadingIndicator();
        showAlert("Funds released successfully!", "success");
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    document.getElementById('pauseContract').addEventListener('click', async () => {
      try {
        showLoadingIndicator();
        await contract.methods.pause().send({ from: account });
        hideLoadingIndicator();
        showAlert("Contract paused successfully!", "success");
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    document.getElementById('unpauseContract').addEventListener('click', async () => {
      try {
        showLoadingIndicator();
        await contract.methods.unpause().send({ from: account });
        hideLoadingIndicator();
        showAlert("Contract unpaused successfully!", "success");
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    document.getElementById('transferOwnership').addEventListener('click', async () => {
      const newOwner = document.getElementById('newOwner').value;
      if (!newOwner) {
        showAlert("Please enter new owner address", "warning");
        return;
      }
      if (!web3.utils.isAddress(newOwner)) {
        showAlert("Invalid address", "warning");
        return;
      }
      try {
        showLoadingIndicator();
        await contract.methods.transferOwnership(newOwner).send({ from: account });
        hideLoadingIndicator();
        showAlert("Ownership transferred successfully!", "success");
        contractOwner = newOwner;
        initWeb3();
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    document.getElementById('removeEvent').addEventListener('click', async () => {
      const eventId = document.getElementById('removeEventId').value;
      if (!eventId) {
        showAlert("Please enter event ID", "warning");
        return;
      }
      try {
        showLoadingIndicator();
        await contract.methods.removeEvent(eventId).send({ from: account });
        hideLoadingIndicator();
        showAlert("Event removed successfully!", "success");
        loadEvents();
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    function initVerifyForm() {
      const useMyAddressCheckbox = document.getElementById('useMyAddress');
      const attendeeInput = document.getElementById('verifyAttendee');
      attendeeInput.value = account;
      attendeeInput.readOnly = true;

      useMyAddressCheckbox.addEventListener('change', () => {
        if (useMyAddressCheckbox.checked) {
          attendeeInput.value = account;
          attendeeInput.readOnly = true;
        } else {
          attendeeInput.value = '';
          attendeeInput.readOnly = false;
        }
      });
    }

    document.getElementById('verifyTicketForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const eventId = document.getElementById('verifyEventId').value;
      const ticketId = document.getElementById('verifyTicketId').value;
      const useMyAddress = document.getElementById('useMyAddress').checked;
      const attendee = useMyAddress ? account : document.getElementById('verifyAttendee').value;
      if (!eventId || !ticketId || !attendee) {
        showAlert("Please fill all fields", "warning");
        return;
      }
      if (!web3.utils.isAddress(attendee)) {
        showAlert("Invalid attendee address", "warning");
        return;
      }
      try {
        const event = await contract.methods.events(eventId).call();
        if (!event.exists) throw new Error("Event does not exist");
        const isValid = await contract.methods.verifyTicket(eventId, ticketId, attendee).call();
        let message;
        if (isValid && event.canceled) {
          message = "The ticket is valid but the event is canceled. Refunds have been issued.";
        } else {
          message = `Ticket is ${isValid ? 'valid' : 'invalid'}`;
        }
        document.getElementById('verifyResult').innerText = message;
        showAlert(`Verification result: ${message}`, isValid && !event.canceled ? "success" : "warning");
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('transferTicketForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const eventId = document.getElementById('transferEventId').value;
      const ticketId = document.getElementById('transferTicketId').value;
      const seller = document.getElementById('transferTo').value;
      const price = web3.utils.toWei(document.getElementById('resalePrice').value, 'ether');
      if (!eventId || !ticketId || !seller || !price) {
        showAlert("Please fill all fields", "warning");
        return;
      }
      if (!web3.utils.isAddress(seller)) {
        showAlert("Invalid seller address", "warning");
        return;
      }
      try {
        const event = await contract.methods.events(eventId).call();
        if (!event.exists) throw new Error('Event does not exist');
        if (event.canceled) throw new Error('Event is canceled');
        if (!event.transferable) throw new Error('Tickets are not transferable');
        if (parseInt(price) > parseInt(event.resalePriceCap)) {
          throw new Error('Price exceeds resale cap');
        }
        showLoadingIndicator();
        const incentive = await contract.methods.platformIncentive().call();
        await contract.methods.requestTicketTrade(eventId, ticketId, seller, price)
          .send({ from: account, value: incentive });
        hideLoadingIndicator();
        showAlert("Trade request created! Notify the seller to accept.", "success");
        loadPendingPayments();
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    document.getElementById('acceptTransferForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const eventId = document.getElementById('acceptEventId').value;
      const ticketId = document.getElementById('acceptTicketId').value;
      if (!eventId || !ticketId) {
        showAlert("Please fill all fields", "warning");
        return;
      }
      try {
        showLoadingIndicator();
        const request = await contract.methods.tradeRequests(eventId, ticketId).call();
        await contract.methods.completeTicketTrade(eventId, ticketId)
          .send({ from: account, value: request.price });
        hideLoadingIndicator();
        showAlert("Trade completed successfully!", "success");
        loadPendingPayments();
        loadTickets();
      } catch (error) {
        hideLoadingIndicator();
        handleError(error);
      }
    });

    window.addEventListener('load', initWeb3);
  </script>
</body>

</html>